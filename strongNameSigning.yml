# Repo: FirelyTeam/azure-pipeline-templates
# File: strongNameSigning.yml

parameters:
  - name: signingKeyFileName
    type: string
    default: 'FhirNetApi.snk'
    displayName: 'Name of the signing key file, stored at Azure DevOps as Secret File'
  - name: signingToolName
    type: string
    default: 'sn.exe'
    displayName: 'Name of the signing tool, stored at Azure DevOps as Secret File'
  - name: filesForSigning
    type: string
    default: '$(Build.SourcesDirectory)\src\Hl7.Fhir*\bin\Release\*\Hl7.Fhir*.dll'
    displayName: 'Expression for files to sign'
  - name: filesToExcludeForSigning
    type: string
    default: '_no_exclude_'
    displayName: 'Expression for files to exclude for signing'

steps:
  - task: DownloadSecureFile@1
    displayName: Download Signing key file
    name: signingKey
    inputs:
      secureFile:  '${{ parameters.signingKeyFileName }}'
  - task: DownloadSecureFile@1
    name: signingTool
    displayName: 'Download Signing key file'
    inputs:
      secureFile: '${{ parameters.signingToolName }}'
  - powershell: |
        $files   =  Get-ChildItem -Path ${{ parameters.filesForSigning }} -Exclude ${{ parameters.filesToExcludeForSigning }}

        Write-Verbose "Last exitcode before signing: $lastexitcode"
        foreach ($file in ($files))
        {
          Write-Host "Signing file: $file"

          & '$(signingTool.secureFilePath)' -R $file $(signingKey.secureFilePath)
          Write-Verbose "Last exitcode after signing file: $lastexitcode"
        }
        Write-Verbose "Last exitcode after signing all files: $lastexitcode"
        # suppress exitcode 
        if ($lastexitcode -lt 2) { $global:lastexitcode = 0 }
    displayName: Signing the dlls
    name: signing
  