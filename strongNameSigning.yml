# Repo: FirelyTeam/azure-pipeline-templates
# File: strongNameSigning.yml

parameters:
  - name: signingKeyFileName
    type: string
    default: 'FhirNetApi.snk'
    displayName: 'Name of the signing key file'
  - name: filesForSigning
    type: string
    default: '$(Build.SourcesDirectory)\src\Hl7.Fhir*\bin\Release\*\Hl7.Fhir*.dll'
    displayName: 'Files to sign'
  - name: filesToExcludeForSigning
    type: string
    default: '_no_exclude_'
    displayName: 'Strong name key file'

steps:
  - task: DownloadSecureFile@1
    displayName: Download Signing key file
    inputs:
      secureFile:  '${{ parameters.signingKeyFileName }}'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest')) # not a PR
  - powershell: |
        $files   =  Get-ChildItem -Path ${{ parameters.filesForSigning }} -Exclude ${{ parameters.filesToExcludeForSigning }}

        Write-Verbose "Last exitcode before signing: $lastexitcode"
        foreach ($file in ($files))
        {
          Write-Verbose "Signing file: $file"

          & 'tools/sn.exe' -R $file $(Agent.TempDirectory)/${{ parameters.signingKeyFileName }}
          Write-Verbose "Last exitcode after signing file: $lastexitcode"
        }
        Write-Verbose "Last exitcode after signing all files: $lastexitcode"
        # suppress exitcode 
        if ($lastexitcode -lt 2) { $global:lastexitcode = 0 }
    displayName: Signing the dlls
    name: signing
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest')) # not a PR
  