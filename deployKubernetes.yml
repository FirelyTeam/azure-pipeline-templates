# Repo: FirelyTeam/azure-pipeline-templates
# File: deployKubernetes.yml 

# This Azure Pipeline template is used to deploy a Dockerized application packaged as a helm chart to a Kubernetes cluster.

parameters:
- name: deploymentJobName
  type: string
  default: 'deployToKubernetes'
  displayName: 'Name of the deployment job'
- name: displayName
  type: string
  default: 'Deyploy to Kubernetes'
  displayName: 'Display name of this deployment job'
- name: environment
  type: string
  default: ''
  displayName: 'Target environment name'
- name: kubernetesServiceConnection
  type: string
  default: ''
  displayName: 'Name of the Kubernetes Service Connection in Azure Devops'
- name: helmVersion
  type: string
  default: 'latest'
  displayName: 'Helm version to install'
- name: kubectlVersion
  type: string
  default: 'latest'
  displayName: 'Kubectl version to install'
- name: localValues
  type: string
  default: ''
  displayName: 'Relative path to the values.yaml file on the local repository'
- name: infraValues
  type: string
  default: ''
  displayName: 'Relative path to the common values.yaml file on the infrastructure repository'
- name: infraRepositoryName
  type: string
  default: ''
  displayName: 'Name of the infrastructure repository'
- name: helmChartRepository
  type: string
  default: ''
  displayName: 'Helm chart repository of the application'
- name: helmChartName
  type: string
  default: ''
  displayName: 'Name of the Helm chart of the application'
- name: helmChartVersion
  type: string
  default: ''
  displayName: 'Version of the Helm chart of the application' 
- name: image
  type: string
  default: ''
  displayName: 'The Docker image including the registry, i.e firely.azurecr.io/firely/server'
- name: imageTag
  type: string 
  default: ''
  displayName: 'Tag of Docker image'
- name: namespace
  type: string
  default: 'default'
  displayName: 'The namespace of the Kubernetes cluster where the application will be deployed'
- name: releaseName
  type: string
  default: ''
  displayName: 'Name of the release used by Helm'

jobs:
- deployment: ${{ parameters.deploymentJobName }}
  environment: ${{ parameters.environment }}
  displayName: ${{ parameters.displayName }}
  strategy:
    runOnce:
      deploy:
        steps:
        - download: none
        - checkout: self
          path: localRepo
          displayName: 'Checkout local repository'
        - checkout: ${{ parameters.infraRepositoryName }}
          path: infraRepo
          displayName: 'Checkout infrastructure repository'
        - task: HelmInstaller@1
          displayName: 'Install Helm ${{ parameters.helmVersion }}'
          inputs:
            helmVersionToInstall: ${{ parameters.helmVersion }}
        - task: KubectlInstaller@0
          displayName: 'Install kubectl ${{ parameters.kubectlVersion }}'
          inputs:
            kubectlVersion: ${{ parameters.kubectlVersion }}
        
        - powershell: |
            Write-Host "Current Directory: $(Get-Location)"
            Write-Host "Pipeline.Workspace: $(Pipeline.Workspace)"
            Write-Host "Listing contents of Pipeline.Workspace:"
            ls $(Pipeline.Workspace)
            Write-Host "Listing contents of local repository (using Pipeline.Workspace):"
            ls $(Pipeline.Workspace)/localRepo
            Write-Host "Listing contents of infrastructure repository (using Pipeline.Workspace):"
            ls $(Pipeline.Workspace)/infraRepo
            $filesToCheck = @("$(Pipeline.Workspace)/localRepo/${{ parameters.localValues }}", "$(Pipeline.Workspace)/infraRepo/${{ parameters.infraValues }}")
            foreach ($filePath in $filesToCheck) {
                if (-not (Test-Path $filePath)) {
                    Write-Host "File $filePath does not exist"
                    Exit 1
                }
            }
          displayName: 'Check if files provided as parameters exists'

        - task: HelmDeploy@0
          displayName: 'helm add repo stable'
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}
            command: repo
            arguments: 'add "stable" "https://charts.helm.sh/stable" --force-update'
        
        - task: HelmDeploy@0
          displayName: 'helm add repo firely'
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}
            command: repo
            arguments: 'add firely ${{ parameters.helmChartRepository }} --force-update'
            failOnStderr: true  
            
        - task: HelmDeploy@0
          displayName: 'helm update repo '
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}
            command: repo
            arguments: update
            failOnStderr: true

        - task: HelmDeploy@0
          displayName: 'helm upgrade ${{ parameters.releaseName }}'
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}
            command: upgrade
            chartName: ${{ parameters.helmChartName }}
            releaseName: ${{ parameters.releaseName }}
            overrideValues: 'image.tag=${{ parameters.imageTag }},image.repository=${{ parameters.image }}'
            valueFile: '$(Pipeline.Workspace)/localRepo/${{ parameters.localValues }}'
            arguments: '--timeout 10m --atomic --version ${{ parameters.helmChartVersion }} --namespace ${{ parameters.namespace }} --create-namespace -f $(Pipeline.Workspace)/infraRepo/${{ parameters.infraValues }}'
            failOnStderr: false            
