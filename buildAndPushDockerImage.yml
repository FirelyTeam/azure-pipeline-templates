# Repo: FirelyTeam/azure-pipeline-templates
# File: buildAndPushDockerImage.yml

parameters:
- name: dependsOn
  type: string
  default: []
  displayName: 'The name of the job that this job depends on'
- name: publishedCodeArtifactName
  type: string
  default: 'ZipDeployArchive'
  displayName: 'The name of the artifact that contains the published code'
- name: containerRegistry
  type: string
  displayName: 'The name of the Azure Container Registry connection'
  default: 'AzureContainerRegistryConnection'
- name: addLatestTag
  type: boolean
  default: true
  displayName: 'Add the latest tag to the image'
- name: dockerRegistry
  type: string
  default: 'firely.azurecr.io'
  displayName: 'The name of the Docker Registry'
- name: imageRepositoryName
  type: string
  default: 'firely/server'
  displayName: 'The name of the Docker Image Repository'

jobs:
- job: createDockerImage
  displayName: Docker image
  dependsOn: ${{ parameters.dependsOn }}
  steps:
  - task: DownloadPipelineArtifact@2
    displayName: 'Download published code artifact'
    inputs:
      artifactName: ${{ parameters.publishedCodeArtifactName }}
      targetPath: '$(System.DefaultWorkingDirectory)'
  - task: ExtractFiles@1
    displayName: 'Extract zip files'
    inputs:
      archiveFilePatterns: '**/*.zip' 
      destinationFolder: $(System.DefaultWorkingDirectory)/target
      cleanDestinationFolder: true
      overwriteExistingFiles: false
  - task: Docker@2
    displayName: Docker Login
    inputs:
      containerRegistry: ${{ parameters.containerRegistry }}
      command: "login"
  - bash: |
      docker run --privileged --rm tonistiigi/binfmt --install arm64
      docker run --privileged --rm tonistiigi/binfmt
      docker buildx create --use
      docker buildx build --platform linux/amd64,linux/arm64 \
        --build-arg=PUBLISHED_CODE=azuredevops \
        --tag ${{ parameters.dockerRegistry }}/${{ parameters.imageRepositoryName }}:$(Build.BuildNumber) \
        --push \
        --file $(Build.SourcesDirectory)/src/Vonk.Server/Dockerfile \
        $(System.DefaultWorkingDirectory)/target
    displayName: Build and Push Docker image on ${{ parameters.dockerRegistry }}
  - bash: |
      docker tag ${{ parameters.dockerRegistry }}/${{ parameters.imageRepositoryName }}:$(Build.BuildNumber) ${{ parameters.dockerRegistry }}/${{ parameters.imageRepositoryName }}:latest
      docker push ${{ parameters.dockerRegistry }}/${{ parameters.imageRepositoryName }}:latest
    displayName: Tag and push latest image on ${{ parameters.dockerRegistry }}
    condition: ${{ parameters.addLatestTag }}